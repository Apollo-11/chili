name: Deploy Leda to Main Station
on:
  push:
    branches: ["master"]

jobs:
  # PHASE 1: BUILD THE APPLICATION
  build:
    name: Build Next.js Application
    runs-on: ubuntu-latest # GitHub-hosted Linux VM

    steps:
      # Step: Clone your repo
      - name: Checkout
        uses: actions/checkout@v4

      # Step: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24" # Matches your server
          cache: "npm"

      # Step: Install dependencies
      - name: Install leda dependencies
        run: npm ci

      - name: Build styles
        run: npm run build:css

      - name: Install docs dependencies
        run: npm run ci:docs

      - name: Build
        run: |
          npm run build:docs
          [ -d docs/.next ] || { echo "Error: .next folder not created!"; exit 1; }
          ls -la docs/.next

      # - name: Lint
      #   run: npm run lint

      # - name: TS
      #   run: npm run tsc

      - name: Verify artifacts
        run: |
          echo "Files to be uploaded:"
          ls -la docs/.next docs/public
          [ -d docs/.next ] || exit 1

      # Step: Package artifacts for deployment
      - name: Save build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: |
            docs/.next/       # Built Next.js docs
            docs/public/      # Static files for docs
            docs/package.json
            docs/package-lock.json
            dist/styles/      # Built CSS from your components
            package.json      # Main project config
            package-lock.json
          if-no-files-found: error # Fail if .next is missing

  # PHASE 2: DEPLOY TO SERVER
  deploy:
    name: Deploy to Production Server
    needs: build # Waits for build job to complete
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get the build artifacts we saved earlier
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: docs-build # Matches the name from upload step

      - name: List files before transfer (debug)
        run: |
          ls -la
          ls -la docs/
          [ -d docs/.next ] || echo "Warning: .next directory missing"

      # Step 2: Deploy to server via SSH
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }} # Your server's IP address
          username: deployer # The user we set up on your server
          key: ${{ secrets.SERVER_SSH_KEY }} # Private key for authentication
          script: |
            # Navigate to your project directory
            cd /var/www/leda

            # Remove old build files to prevent conflicts
            rm -rf .next public

            # Transfer new files from GitHub to your server:
            # 1. tar -czf - creates a compressed package of our files
            # 2. Pipes (|) this to SSH which extracts it on your server
            tar -czf - -C docs .next/ public/ package.json package-lock.json | \
              ssh deployer@${{ secrets.SERVER_IP }} "cd /var/www/leda && tar -xzf -"

            # Install only production dependencies (no devDependencies)
            # npm ci --production

            # Restart the application using PM2 process manager
            # pm2 restart next-app
